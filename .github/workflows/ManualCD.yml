name: Continuous Deployment

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Select Deployment Target'
        required: true
        default: 'ec2'
        type: choice
        options:
          - local
          - ec2

jobs:
  # --- JOB 1: Deploy to your Rocky Linux (Self-Hosted) ---
  deploy-local:
    if: github.event.inputs.deploy_target == 'local'
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Local Docker Deployment
        run: |
          echo "ðŸš€ Starting Local Deployment..."
          docker pull mennat2003/menna-app:latest
          docker stop app-container || true
          docker rm app-container || true
          docker run -d --name app-container -p 8080:80 mennat2003/menna-app:latest
          echo "âœ… Local Deployment Successful!"

  # --- JOB 2: Deploy to Manual AWS EC2 ---
  deploy-ec2:
    if: github.event.inputs.deploy_target == 'ec2'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}      # Your EC2 Public IP stored in Secrets
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}    # Your Private Key (.pem) content stored in Secrets
          script: |
            echo "ðŸš€ Connecting to EC2 via SSH..."
            sudo docker pull mennat2003/menna-app:latest
            sudo docker stop app-container || true
            sudo docker rm app-container || true
            sudo docker run -d --name app-container -p 8080:80 mennat2003/menna-app:latest
            echo "âœ… EC2 Deployment Successful!"
