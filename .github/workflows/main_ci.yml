name: Project Life Cycle - Task 1

on:
  push:
    branches: [ "task1" ]

env:
  # Environment variables
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/menna-app
  SCAN_DIR: scan-dir

jobs:
  ci-pipeline:
    # Using GitHub's managed Ubuntu server
    runs-on: ubuntu-latest
    timeout-minutes: 20 
    
    steps:
      # Step 1: Pull the latest code from your repository
      - name: 1. Checkout Code
        id: checkout
        uses: actions/checkout@v4

      # Step 2: Static Application Security Testing (SAST)
      # Scans the file system for secrets and vulnerabilities
      - name: 2. Scan Source Code (SAST)
        id: sast_scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1' 
          severity: 'CRITICAL,HIGH'

      # Step 3: Build Docker Image with Commit SHA tag
      - name: 3. Build Docker Image
        id: build_image
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
          docker build -t ${{ env.DOCKER_IMAGE }}:latest -t ${{ env.DOCKER_IMAGE }}:$SHORT_SHA .

      # Step 4: Create a directory to store scan results
      - name: 4. Create Scan Directory
        id: create_dir
        run: mkdir -p ${{ env.SCAN_DIR }}

      # Step 5: Security Scan of the image (Terminal Table Output)
      - name: 5. Image Security Scan (TXT)
        id: image_scan_txt
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}'
          format: 'table'
          output: '${{ env.SCAN_DIR }}/nginx.txt'

      # Step 6: Security Scan of the image (HTML Report Output)
      # Template path fixed for GitHub-hosted runners
      - name: 6. Image Security Scan (HTML)
        id: image_scan_html
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}'
          format: 'template'
          template: '@contrib/html.tpl'
          output: '${{ env.SCAN_DIR }}/report.html'

      # Step 7: Upload the generated reports as a downloadable artifact
      - name: 7. Upload Security Artifacts
        id: upload_artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Security-Reports
          path: ${{ env.SCAN_DIR }}/

      # Step 8: Authenticate with Docker Hub
      - name: 8. Login to Docker Hub
        id: docker_login
        if: success()
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 9: Push both 'latest' and 'SHA' tags to Docker Hub
      - name: 9. Push Image to Docker Hub
        id: push_image
        if: success()
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
