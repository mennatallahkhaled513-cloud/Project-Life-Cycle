name: Project Life Cycle - Task 1

# 1. Auto Trigger on push to task1 branch
on:
  push:
    branches: [ "task1" ]

env:
  # 2. Parameter List / Variable Group
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/menna-app
  SCAN_DIR: scan-dir

jobs:
  ci-pipeline:
    # 3. Service Connection: Local Host (Self-hosted Runner on Rocky Linux)
    runs-on: self-hosted 
    
    steps:
      # Step 1: Get the latest code from the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Build the Docker Image from the Dockerfile
      - name: Build Docker Image
        run: docker build -t ${{ env.DOCKER_IMAGE }}:latest .

      # Step 3: Prepare the directory for scan results
      - name: Create Scan Directory
        run: mkdir -p ${{ env.SCAN_DIR }}

      # Step 4: Run Trivy Security Scan and output as TXT (nginx.txt)
      - name: Security Scan (TXT)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:latest'
          format: 'table'
          output: '${{ env.SCAN_DIR }}/nginx.txt'

      # Step 5: Run Trivy Security Scan and output as HTML (report.html)
      - name: Security Scan (HTML)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: '${{ env.SCAN_DIR }}/report.html'

      # 6. Artifact Pipeline: Expose scan results as downloadable files
      - name: Upload Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Security-Reports
          path: ${{ env.SCAN_DIR }}/

      # Step 7: Login to Docker Hub using secrets
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 8: Push the final image to Docker Hub
      - name: Push to Docker Hub
        run: docker push ${{ env.DOCKER_IMAGE }}:latest
