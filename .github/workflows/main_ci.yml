name: Project Life Cycle - Task 1

on:
  push:
    branches: [ "task1" ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/menna-app
  SCAN_DIR: scan-dir

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 20 
    
    steps:
      # Step 1: Checkout Code
      - name: 1. Checkout Code
        id: checkout
        uses: actions/checkout@v4

      # Step 2: SAST Scan (Code Analysis)
      # This will output a clean table in the logs
      - name: 2. Scan Source Code (SAST)
        id: sast_scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1' 
          severity: 'CRITICAL,HIGH'

      # Step 3: Build Docker Image
      - name: 3. Build Docker Image
        id: build_image
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
          docker build -t ${{ env.DOCKER_IMAGE }}:latest -t ${{ env.DOCKER_IMAGE }}:$SHORT_SHA .

      # Step 4: Create Scan Directory
      - name: 4. Create Scan Directory
        id: create_dir
        run: mkdir -p ${{ env.SCAN_DIR }}

      # Step 5: Image Security Scan (TXT)
      # Using standard table format to avoid path errors
      - name: 5. Image Security Scan (Table Output)
        id: image_scan_txt
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}'
          format: 'table'
          output: '${{ env.SCAN_DIR }}/security-report.txt'

      # Step 6: Upload artifacts
      - name: 6. Upload Security Artifacts
        id: upload_artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Security-Reports
          path: ${{ env.SCAN_DIR }}/

      # Step 7: Login to Docker Hub
      - name: 7. Login to Docker Hub
        id: docker_login
        if: success()
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 8: Push Image to Docker Hub
      - name: 8. Push Image to Docker Hub
        id: push_image
        if: success()
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
