name: Validation Pipeline

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Dockerfile Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Step 1: Check if Dockerfile exists ---
      - name: Verify Dockerfile Existence
        run: |
          if [ -f "Dockerfile" ]; then
            echo "✅ Dockerfile exists."
          else
            echo "❌ Error: Dockerfile is missing!"
            exit 1
          fi

      # --- Step 2: Install Checkov (Prerequisites) ---
      - name: Install Python and Checkov
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install checkov

      # --- Step 3: Run Checkov Scan & Generate HTML ---
      # We use '|| true' to ensure the pipeline continues so we can upload the report 
      # even if it finds security warnings.
      - name: Run Checkov Scan
        run: |
          checkov -f Dockerfile --check CKV_DOCKER_1,CKV_DOCKER_2,CKV_DOCKER_3 --output html > checkov-report.html || true

      # --- Step 4: Upload HTML Report to Artifacts ---
      - name: Upload Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-security-report
          path: checkov-report.html
