name: Validation Pipeline

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Dockerfile & Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Step 1: Verify Dockerfile Existence ---
      - name: Check if Dockerfile exists
        run: |
          if [ -f "Dockerfile" ]; then
            echo "✅ Dockerfile found!"
          else
            echo "❌ Error: Dockerfile NOT found!"
            exit 1
          fi

      # --- Step 2: Install Prerequisites (Python & Checkov) ---
      - name: Install Checkov
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          pip3 install checkov

      # --- Step 3: Run Checkov Scan and Generate HTML ---
      # We output to JSON first, then wrap it in HTML tags for the artifact
      - name: Run Checkov Scan
        run: |
          checkov -f Dockerfile --check CKV_DOCKER_1,CKV_DOCKER_2,CKV_DOCKER_3 -o json > checkov-results.json || true
          
          # Create a simple HTML wrapper to make the JSON readable in a browser
          echo "<html><body style='font-family: sans-serif; background: #f4f4f4; padding: 20px;'>" > checkov-report.html
          echo "<h1>Checkov Security Scan Report</h1>" >> checkov-report.html
          echo "<div style='background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;'>" >> checkov-report.html
          echo "<h3>Scan Results (JSON Format):</h3>" >> checkov-report.html
          echo "<pre>$(cat checkov-results.json | jq .)</pre>" >> checkov-report.html
          echo "</div></body></html>" >> checkov-report.html

      # --- Step 4: Upload Report as Artifact ---
      - name: Upload Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-security-report
          path: checkov-report.html
